<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Permohonan Dokumen Kependudukan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .captcha-box {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 3px;
            color: #495057;
        }
        .camera-preview {
            width: 200px;
            height: 150px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">Formulir Permohonan</h1>
            <p class="text-blue-100">Dokumen Kependudukan Online</p>
        </div>

        <!-- Form Container -->
        <div class="glass-effect rounded-2xl shadow-2xl p-8">
            <form id="applicationForm" class="space-y-6">
                <!-- Tanggal Permohonan -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üìÖ Tanggal Permohonan
                        </label>
                        <input type="date" id="tanggalPermohonan" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <!-- Jenis Permohonan -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üìã Jenis Permohonan
                        </label>
                        <select id="jenisPermohonan" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Pilih Jenis Permohonan</option>
                            <option value="Kartu Keluarga">Kartu Keluarga</option>
                            <option value="KTP El">KTP Elektronik</option>
                            <option value="Kartu Identitas Anak">Kartu Identitas Anak</option>
                            <option value="SKPWNI">SKPWNI</option>
                            <option value="SKDWNI">SKDWNI</option>
                            <option value="Akta Kelahiran">Akta Kelahiran</option>
                            <option value="Akta Kematian">Akta Kematian</option>
                            <option value="Akta Perkawinan">Akta Perkawinan</option>
                        </select>
                    </div>
                </div>

                <!-- NIK dan Nama Pemohon -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üÜî NIK Pemohon
                        </label>
                        <input type="text" id="nikPemohon" required maxlength="16" pattern="[0-9]{16}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="16 digit NIK">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üë§ Nama Lengkap Pemohon
                        </label>
                        <input type="text" id="namaPemohon" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Nama lengkap sesuai KTP">
                    </div>
                </div>

                <!-- Bermohon Atas Nama -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üë• Bermohon Atas Nama
                    </label>
                    <input type="text" id="bermohonAtasNama" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Nama Lengkap/Bayi/Anak/Jenazah">
                </div>

                <!-- Tempat dan Tanggal Lahir -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üèôÔ∏è Tempat Lahir
                        </label>
                        <input type="text" id="tempatLahir" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Kota/Kabupaten">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üìÖ Tanggal Lahir
                        </label>
                        <input type="date" id="tanggalLahir" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ‚ößÔ∏è Jenis Kelamin
                        </label>
                        <select id="jenisKelamin" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Pilih</option>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                </div>

                <!-- Status Perkawinan -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üíç Status Perkawinan
                    </label>
                    <select id="statusPerkawinan" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Pilih Status</option>
                        <option value="Belum Kawin">Belum Kawin</option>
                        <option value="Kawin">Kawin</option>
                        <option value="Cerai Mati">Cerai Mati</option>
                        <option value="Cerai Hidup">Cerai Hidup</option>
                    </select>
                </div>

                <!-- Nama Orang Tua -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üë© Nama Lengkap Ibu
                        </label>
                        <input type="text" id="namaIbu" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Nama lengkap ibu kandung">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üë® Nama Lengkap Ayah <span class="text-gray-500">(Opsional)</span>
                        </label>
                        <input type="text" id="namaAyah"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Nama lengkap ayah kandung">
                    </div>
                </div>

                <!-- Alamat -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üèõÔ∏è Kecamatan
                        </label>
                        <select id="kecamatan" required onchange="updateDesa()"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Pilih Kecamatan</option>
                            <option value="Tanimbar Selatan">Tanimbar Selatan</option>
                            <option value="Selaru">Selaru</option>
                            <option value="Wertamrian">Wertamrian</option>
                            <option value="Wermaktian">Wermaktian</option>
                            <option value="Tanimbar Utara">Tanimbar Utara</option>
                            <option value="Fordata">Fordata</option>
                            <option value="Wuarlabobar">Wuarlabobar</option>
                            <option value="Kormomolin">Kormomolin</option>
                            <option value="Nirunmas">Nirunmas</option>
                            <option value="Molumaru">Molumaru</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üèòÔ∏è Desa/Kelurahan
                        </label>
                        <select id="desa" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Pilih Desa/Kelurahan</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üè† RT/RW
                    </label>
                    <input type="text" id="rtRw" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Contoh: 001/002">
                </div>

                <!-- Upload File -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üìé Upload File Pendukung (PDF) - Wajib
                    </label>
                    <input type="file" id="filePendukung" accept=".pdf" required onchange="validatePDFFile()"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <div class="mt-2 space-y-1">
                        <p class="text-sm text-gray-500">‚Ä¢ File harus dalam format PDF</p>
                        <p class="text-sm text-gray-500">‚Ä¢ Ukuran maksimal 5MB</p>
                        <p class="text-sm text-gray-500">‚Ä¢ File akan dikonversi ke Base64 untuk dikirim</p>
                    </div>
                    <div id="fileStatus" class="mt-2 text-sm"></div>
                </div>

                <!-- Verifikasi Biometrik -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üì∏ Verifikasi Biometrik (Wajib)
                    </label>
                    <div class="flex flex-col items-center space-y-4">
                        <video id="cameraVideo" width="300" height="225" autoplay style="display: none;" class="border-2 border-gray-300 rounded-lg"></video>
                        <div class="camera-preview" id="cameraPreview">
                            <span class="text-gray-500">üì∑ Klik "Aktifkan Kamera" untuk mulai</span>
                        </div>
                        <canvas id="photoCanvas" width="300" height="225" style="display: none;"></canvas>
                        
                        <div class="flex space-x-3">
                            <button type="button" id="startCameraBtn" onclick="startCamera()"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                üìπ Aktifkan Kamera
                            </button>
                            <button type="button" id="captureBtn" onclick="capturePhoto()" disabled
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400">
                                üì∏ Ambil Foto
                            </button>
                            <button type="button" id="retakeBtn" onclick="retakePhoto()" style="display: none;"
                                    class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                                üîÑ Foto Ulang
                            </button>
                        </div>
                        
                        <div id="photoStatus" class="text-sm text-gray-600"></div>
                    </div>
                </div>

                <!-- CAPTCHA -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üîí Verifikasi CAPTCHA
                    </label>
                    <div class="flex items-center space-x-4">
                        <div class="captcha-box rounded-lg" id="captchaDisplay">
                            <span id="captchaText">LOADING...</span>
                        </div>
                        <button type="button" onclick="generateCaptcha()"
                                class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            üîÑ Refresh
                        </button>
                    </div>
                    <input type="text" id="captchaInput" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mt-2"
                           placeholder="Masukkan kode CAPTCHA">
                </div>

                <!-- Syarat dan Ketentuan -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="flex items-start space-x-3">
                        <input type="checkbox" id="agreement" required
                               class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <span class="text-sm text-gray-700">
                            Saya menyetujui <strong>Syarat dan Ketentuan</strong> yang berlaku dan menyatakan bahwa data yang saya berikan adalah benar dan dapat dipertanggungjawabkan secara hukum.
                        </span>
                    </label>
                </div>

                <!-- Submit Button -->
                <div class="text-center pt-6">
                    <button type="submit" id="submitBtn"
                            class="w-full md:w-auto px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                        üì§ Kirim Permohonan
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading Modal -->
        <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-700">Mengirim permohonan...</p>
            </div>
        </div>

        <!-- Success Modal -->
        <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 text-center max-w-md mx-4">
                <div class="text-green-600 text-6xl mb-4">‚úÖ</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Permohonan Berhasil Dikirim!</h3>
                <p class="text-gray-600 mb-4">Data Anda telah tersimpan dan akan diproses segera.</p>
                <button onclick="closeSuccessModal()" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <script>
        // Data desa berdasarkan kecamatan
        const desaData = {
            "Tanimbar Selatan": ["Saumlaki", "Saumlaki Utara", "Wowonda", "Ilngei", "Kabiarat", "Lauran", "Sifnana", "Olilit Raya", "Lermatang", "Latdalam", "Bomaki", "Matakus"],
            "Selaru": ["Adaut", "Namtabung", "Kandar", "Lingat", "Fursuy", "Werain", "Eliasa"],
            "Wertamrian": ["Tumbur", "Lorulun", "Atubul Dol", "Amdasa", "Sangliat Krawain", "Arui Bab", "Arui Das", "Sangliat Dol", "Atubul Da"],
            "Wermaktian": ["Kamatubun", "Rumah Salut", "Welutu", "Themin", "Weratan", "Wermatan", "Otemer", "Makatian", "Marantutul"],
            "Tanimbar Utara": ["Lelingluan", "Ritabel", "Ridool", "Watidal", "Keliobar", "Kelaan", "Lamdesar Barat", "Lamdesar Timur"],
            "Fordata": ["Romean", "Rumngeur", "Awear", "Sofyanin", "Walerang", "Adodo Fordata"],
            "Wuarlabobar": ["Abat", "Labobar", "Watmasa", "Awear Rumngeur", "Karatat", "Wunlah", "Kiloon", "Lingada", "Teineman", "Wabar", "Romnus"],
            "Kormomolin": ["Lumasebu", "Kilmasa", "Meyano Bab", "Alusi Krawain", "Alusi Kelaan", "Alusi Bukjalim", "Alusi Tamrian", "Alusi Batjas", "Lorwembun", "Meyano Das"],
            "Nirunmas": ["Arma", "Watmuri", "Manglusi", "Tutukembong", "Waturu"],
            "Molumaru": ["Wedangkou", "Adodo Molu", "Wulmasa", "Tutunametal", "Nurkat"]
        };

        let currentCaptcha = '';
        let photoTaken = false;
        let cameraStream = null;
        let capturedPhotoData = null;
        let validPDFFile = null;

        // Set tanggal hari ini
        document.getElementById('tanggalPermohonan').valueAsDate = new Date();

        // Update desa berdasarkan kecamatan
        function updateDesa() {
            const kecamatan = document.getElementById('kecamatan').value;
            const desaSelect = document.getElementById('desa');
            
            desaSelect.innerHTML = '<option value="">Pilih Desa/Kelurahan</option>';
            
            if (kecamatan && desaData[kecamatan]) {
                desaData[kecamatan].forEach(desa => {
                    const option = document.createElement('option');
                    option.value = desa;
                    option.textContent = desa;
                    desaSelect.appendChild(option);
                });
            }
        }

        // Generate CAPTCHA
        function generateCaptcha() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let captcha = '';
            for (let i = 0; i < 6; i++) {
                captcha += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            currentCaptcha = captcha;
            document.getElementById('captchaText').textContent = captcha;
        }

        // Deteksi apakah perangkat mobile
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
        }

        // Aktifkan kamera
        async function startCamera() {
            const video = document.getElementById('cameraVideo');
            const preview = document.getElementById('cameraPreview');
            const startBtn = document.getElementById('startCameraBtn');
            const captureBtn = document.getElementById('captureBtn');
            
            try {
                // Update status loading
                startBtn.disabled = true;
                startBtn.textContent = '‚è≥ Mengaktifkan...';
                document.getElementById('photoStatus').innerHTML = 
                    '<span class="text-blue-600">üîÑ Meminta izin akses kamera...</span>';
                
                // Cek apakah browser mendukung getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Browser tidak mendukung akses kamera');
                }

                // Deteksi perangkat mobile
                const isMobile = isMobileDevice();
                console.log('Perangkat mobile:', isMobile);
                
                // Konfigurasi kamera yang dioptimalkan untuk mobile dan desktop
                let constraints = [];
                
                if (isMobile) {
                    // Konfigurasi khusus mobile
                    constraints = [
                        // Mobile: Kamera depan dengan resolusi rendah
                        { 
                            video: { 
                                width: { min: 240, ideal: 320, max: 640 }, 
                                height: { min: 180, ideal: 240, max: 480 },
                                facingMode: 'user'
                            } 
                        },
                        // Mobile: Kamera belakang dengan resolusi rendah
                        { 
                            video: { 
                                width: { min: 240, ideal: 320, max: 640 }, 
                                height: { min: 180, ideal: 240, max: 480 },
                                facingMode: 'environment'
                            } 
                        },
                        // Mobile: Tanpa facingMode, resolusi rendah
                        { 
                            video: { 
                                width: { min: 240, ideal: 320, max: 640 }, 
                                height: { min: 180, ideal: 240, max: 480 }
                            } 
                        },
                        // Mobile: Konfigurasi paling sederhana
                        { 
                            video: { 
                                width: { ideal: 320 }, 
                                height: { ideal: 240 }
                            } 
                        },
                        // Mobile: Fallback terakhir
                        { video: true }
                    ];
                } else {
                    // Konfigurasi desktop (seperti sebelumnya)
                    constraints = [
                        { 
                            video: { 
                                width: { ideal: 300 }, 
                                height: { ideal: 225 },
                                facingMode: 'user'
                            } 
                        },
                        { 
                            video: { 
                                width: { ideal: 300 }, 
                                height: { ideal: 225 },
                                facingMode: 'environment'
                            } 
                        },
                        { 
                            video: { 
                                width: { ideal: 300 }, 
                                height: { ideal: 225 }
                            } 
                        },
                        { video: true }
                    ];
                }
                
                let stream = null;
                let lastError = null;
                
                // Coba setiap konfigurasi sampai berhasil
                for (let i = 0; i < constraints.length; i++) {
                    try {
                        console.log(`Mencoba konfigurasi ${i + 1}/${constraints.length}:`, constraints[i]);
                        
                        // Update status untuk setiap percobaan
                        document.getElementById('photoStatus').innerHTML = 
                            `<span class="text-blue-600">üîÑ Mencoba konfigurasi ${i + 1}/${constraints.length}...</span>`;
                        
                        stream = await navigator.mediaDevices.getUserMedia(constraints[i]);
                        console.log('Konfigurasi berhasil:', constraints[i]);
                        break; // Berhasil, keluar dari loop
                    } catch (err) {
                        console.log(`Konfigurasi ${i + 1} gagal:`, err.message);
                        lastError = err;
                        
                        // Tunggu sebentar sebelum mencoba konfigurasi berikutnya
                        if (i < constraints.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                        continue;
                    }
                }
                
                if (!stream) {
                    throw lastError || new Error('Semua konfigurasi kamera gagal');
                }
                
                cameraStream = stream;
                
                // Set video source
                video.srcObject = stream;
                
                // Untuk mobile, set atribut tambahan
                if (isMobile) {
                    video.setAttribute('playsinline', 'true');
                    video.setAttribute('webkit-playsinline', 'true');
                    video.muted = true; // Penting untuk autoplay di mobile
                }
                
                // Tunggu video siap diputar dengan timeout yang lebih panjang untuk mobile
                const timeoutDuration = isMobile ? 15000 : 10000;
                
                await new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        reject(new Error('Timeout loading video'));
                    }, timeoutDuration);
                    
                    video.onloadedmetadata = () => {
                        clearTimeout(timeoutId);
                        console.log('Video metadata loaded');
                        
                        // Untuk mobile, coba play dengan promise
                        const playPromise = video.play();
                        
                        if (playPromise !== undefined) {
                            playPromise
                                .then(() => {
                                    console.log('Video playing successfully');
                                    resolve();
                                })
                                .catch((err) => {
                                    console.log('Play error:', err);
                                    // Coba lagi tanpa autoplay
                                    video.autoplay = false;
                                    setTimeout(() => {
                                        video.play().then(resolve).catch(reject);
                                    }, 100);
                                });
                        } else {
                            resolve();
                        }
                    };
                    
                    video.onerror = (err) => {
                        clearTimeout(timeoutId);
                        reject(err);
                    };
                    
                    // Trigger loading jika belum dimulai
                    if (video.readyState === 0) {
                        video.load();
                    }
                });
                
                // Tampilkan video dan sembunyikan preview
                video.style.display = 'block';
                preview.style.display = 'none';
                
                // Update UI
                startBtn.textContent = 'üìπ Kamera Aktif';
                captureBtn.disabled = false;
                
                const deviceType = isMobile ? 'mobile' : 'desktop';
                document.getElementById('photoStatus').innerHTML = 
                    `<span class="text-green-600">‚úÖ Kamera berhasil diaktifkan (${deviceType}). Posisikan wajah Anda dan klik "Ambil Foto"</span>`;
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                
                // Reset UI
                startBtn.disabled = false;
                startBtn.textContent = 'üìπ Aktifkan Kamera';
                captureBtn.disabled = true;
                
                // Tampilkan pesan error yang lebih informatif
                let errorMessage = '';
                const isMobile = isMobileDevice();
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    if (isMobile) {
                        errorMessage = '‚ùå Izin kamera ditolak. Di HP: Buka Settings browser ‚Üí Site Settings ‚Üí Camera ‚Üí Allow. Lalu refresh halaman.';
                    } else {
                        errorMessage = '‚ùå Izin kamera ditolak. Klik ikon kamera di address bar dan pilih "Allow", lalu refresh halaman.';
                    }
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage = '‚ùå Kamera tidak ditemukan. Pastikan perangkat memiliki kamera dan tidak diblokir.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    if (isMobile) {
                        errorMessage = '‚ùå Kamera sedang digunakan aplikasi lain. Tutup semua aplikasi kamera dan refresh halaman.';
                    } else {
                        errorMessage = '‚ùå Kamera sedang digunakan aplikasi lain. Tutup aplikasi lain dan coba lagi.';
                    }
                } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    errorMessage = '‚ùå Kamera tidak mendukung konfigurasi yang diminta. Coba gunakan browser lain.';
                } else if (error.message.includes('Browser tidak mendukung')) {
                    if (isMobile) {
                        errorMessage = '‚ùå Browser tidak mendukung kamera. Gunakan Chrome, Firefox, atau Safari terbaru.';
                    } else {
                        errorMessage = '‚ùå Browser tidak mendukung akses kamera. Gunakan browser modern seperti Chrome, Firefox, atau Safari.';
                    }
                } else if (error.message.includes('Timeout')) {
                    errorMessage = '‚ùå Kamera terlalu lama loading. Coba refresh halaman atau restart browser.';
                } else {
                    errorMessage = `‚ùå Gagal mengakses kamera: ${error.message}. Coba refresh halaman.`;
                }
                
                document.getElementById('photoStatus').innerHTML = 
                    `<span class="text-red-600">${errorMessage}</span>`;
                
                // Bersihkan stream jika ada
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
            }
        }

        // Ambil foto dari kamera
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            const preview = document.getElementById('cameraPreview');
            
            // Gambar frame video ke canvas
            ctx.drawImage(video, 0, 0, 300, 225);
            
            // Konversi ke base64
            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Tampilkan hasil foto
            canvas.style.display = 'block';
            video.style.display = 'none';
            
            // Update UI
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-block';
            
            document.getElementById('photoStatus').innerHTML = 
                '<span class="text-green-600">‚úÖ Foto berhasil diambil! Klik "Foto Ulang" jika ingin mengambil ulang.</span>';
            
            photoTaken = true;
            
            // Hentikan kamera
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        }

        // Foto ulang
        function retakePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const captureBtn = document.getElementById('captureBtn');
            const retakeBtn = document.getElementById('retakeBtn');
            
            canvas.style.display = 'none';
            captureBtn.style.display = 'inline-block';
            captureBtn.disabled = false;
            retakeBtn.style.display = 'none';
            
            capturedPhotoData = null;
            photoTaken = false;
            
            // Aktifkan kamera lagi
            startCamera();
        }

        // Validasi file PDF
        function validatePDFFile() {
            const fileInput = document.getElementById('filePendukung');
            const fileStatus = document.getElementById('fileStatus');
            
            if (fileInput.files.length === 0) {
                fileStatus.innerHTML = '';
                validPDFFile = null;
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validasi tipe file
            if (file.type !== 'application/pdf') {
                fileStatus.innerHTML = '<span class="text-red-600">‚ùå File harus dalam format PDF!</span>';
                fileInput.value = '';
                validPDFFile = null;
                return;
            }
            
            // Validasi ukuran file (5MB = 5 * 1024 * 1024 bytes)
            if (file.size > 5 * 1024 * 1024) {
                fileStatus.innerHTML = '<span class="text-red-600">‚ùå Ukuran file maksimal 5MB!</span>';
                fileInput.value = '';
                validPDFFile = null;
                return;
            }
            
            // File valid
            validPDFFile = file;
            const fileSizeKB = Math.round(file.size / 1024);
            fileStatus.innerHTML = `<span class="text-green-600">‚úÖ File PDF valid (${fileSizeKB} KB)</span>`;
            
            // Konversi ke Base64 untuk dikirim
            const reader = new FileReader();
            reader.onload = function(e) {
                validPDFFile.base64Data = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Form submission
        document.getElementById('applicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validasi CAPTCHA
            const captchaInput = document.getElementById('captchaInput').value.toUpperCase();
            if (captchaInput !== currentCaptcha) {
                alert('Kode CAPTCHA tidak sesuai!');
                return;
            }
            
            // Validasi foto biometrik
            if (!photoTaken || !capturedPhotoData) {
                alert('Silakan ambil foto wajah untuk verifikasi biometrik terlebih dahulu!');
                return;
            }
            
            // Validasi file PDF
            if (!validPDFFile || !validPDFFile.base64Data) {
                alert('Silakan upload file pendukung dalam format PDF!');
                return;
            }
            
            // Show loading
            document.getElementById('loadingModal').classList.remove('hidden');
            document.getElementById('loadingModal').classList.add('flex');
            
            // Collect form data
            const formData = {
                tanggalPermohonan: document.getElementById('tanggalPermohonan').value,
                jenisPermohonan: document.getElementById('jenisPermohonan').value,
                nikPemohon: document.getElementById('nikPemohon').value,
                namaPemohon: document.getElementById('namaPemohon').value,
                bermohonAtasNama: document.getElementById('bermohonAtasNama').value,
                tempatLahir: document.getElementById('tempatLahir').value,
                tanggalLahir: document.getElementById('tanggalLahir').value,
                jenisKelamin: document.getElementById('jenisKelamin').value,
                statusPerkawinan: document.getElementById('statusPerkawinan').value,
                namaIbu: document.getElementById('namaIbu').value,
                namaAyah: document.getElementById('namaAyah').value,
                kecamatan: document.getElementById('kecamatan').value,
                desa: document.getElementById('desa').value,
                rtRw: document.getElementById('rtRw').value,
                fileName: validPDFFile.name,
                fileSize: validPDFFile.size,
                filePDF: validPDFFile.base64Data, // Data PDF dalam Base64
                fotoBiometrik: capturedPhotoData, // Data foto dalam Base64
                timestamp: new Date().toISOString()
            };
            
            // Kirim data ke Google Sheets
            try {
                await submitToGoogleSheets(formData);
                
                // Hide loading and show success
                document.getElementById('loadingModal').classList.add('hidden');
                document.getElementById('loadingModal').classList.remove('flex');
                document.getElementById('successModal').classList.remove('hidden');
                document.getElementById('successModal').classList.add('flex');
                
            } catch (error) {
                document.getElementById('loadingModal').classList.add('hidden');
                document.getElementById('loadingModal').classList.remove('flex');
                alert('Terjadi kesalahan saat mengirim data. Silakan coba lagi.');
            }
        });
        
        // Kirim data ke Google Sheets
        async function submitToGoogleSheets(data) {
            // URL Web App Google Apps Script - GANTI DENGAN URL ANDA
            const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxvqIt1Ds-iI1iPposxkuqC2c_IDX6gaZYb44lS6dLkVirCyJaIKMvrMotAIgIp2ZUQ/exec';
            
            try {
                // Kirim sebagai FormData untuk kompatibilitas yang lebih baik
                const formData = new FormData();
                formData.append('nikPemohon', data.nikPemohon || '');
                formData.append('namaPemohon', data.namaPemohon || '');
                formData.append('tanggalPermohonan', data.tanggalPermohonan || '');
                formData.append('jenisPermohonan', data.jenisPermohonan || '');
                formData.append('bermohonAtasNama', data.bermohonAtasNama || '');
                formData.append('tempatLahir', data.tempatLahir || '');
                formData.append('tanggalLahir', data.tanggalLahir || '');
                formData.append('jenisKelamin', data.jenisKelamin || '');
                formData.append('statusPerkawinan', data.statusPerkawinan || '');
                formData.append('namaIbu', data.namaIbu || '');
                formData.append('namaAyah', data.namaAyah || '');
                formData.append('kecamatan', data.kecamatan || '');
                formData.append('desa', data.desa || '');
                formData.append('rtRw', data.rtRw || '');
                formData.append('fileName', data.fileName || '');
                formData.append('fileSize', data.fileSize || '');
                formData.append('filePDF', data.filePDF || '');
                formData.append('fotoBiometrik', data.fotoBiometrik || '');
                formData.append('timestamp', data.timestamp || new Date().toISOString());
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.text();
                console.log('Response:', result);
                
                // Coba parse sebagai JSON jika memungkinkan
                try {
                    const jsonResult = JSON.parse(result);
                    if (jsonResult.success === false) {
                        throw new Error(jsonResult.error || 'Server mengembalikan error');
                    }
                    return jsonResult;
                } catch (parseError) {
                    // Jika tidak bisa parse JSON, anggap berhasil jika response ada
                    if (result && result.length > 0) {
                        return { success: true, response: result };
                    } else {
                        throw new Error('Response kosong dari server');
                    }
                }
                
            } catch (error) {
                console.error('Error:', error);
                throw new Error(`Gagal mengirim data: ${error.message}`);
            }
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
            document.getElementById('applicationForm').reset();
            document.getElementById('tanggalPermohonan').valueAsDate = new Date();
            
            // Reset kamera dan foto
            document.getElementById('cameraPreview').innerHTML = '<span class="text-gray-500">üì∑ Klik "Aktifkan Kamera" untuk mulai</span>';
            document.getElementById('cameraPreview').style.display = 'flex';
            document.getElementById('cameraVideo').style.display = 'none';
            document.getElementById('photoCanvas').style.display = 'none';
            document.getElementById('startCameraBtn').disabled = false;
            document.getElementById('startCameraBtn').textContent = 'üìπ Aktifkan Kamera';
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('captureBtn').style.display = 'inline-block';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('photoStatus').innerHTML = '';
            
            // Reset file
            document.getElementById('fileStatus').innerHTML = '';
            
            // Reset variables
            photoTaken = false;
            capturedPhotoData = null;
            validPDFFile = null;
            
            // Stop camera if active
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            generateCaptcha();
        }
        
        // Initialize
        generateCaptcha();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98618951664f601d',t:'MTc1OTA0NDYzNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
